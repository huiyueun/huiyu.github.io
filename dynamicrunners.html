<!DOCTYPE html>>
<html>
<head>
    <meta property="og:title" content="Dynamic Runners 1st Marathon"/>
    <meta property="og:url" content="https://huiyueun.github.io/dynamicrunners.html"/>
    <meta property="og:image" content="dy_certificate_bg.jpg"/>
    <meta property="og:description" content="Online ceritifiace"/>
<script>
var jsonp = function (url) {
    var script = window.document.createElement('script');
    script.async = true;
    script.src = url;
    script.onerror = function () {
        alert('Can not access JSONP file.')
    };
    var done = false;
    script.onload = script.onreadystatechange = function () {
        if (!done && (!this.readyState || this.readyState === 'loaded' || this.readyState ===
                'complete')) {
            done = true;
            script.onload = script.onreadystatechange = null;
            if (script.parentNode) {
                return script.parentNode.removeChild(script);
            }
        }
    };
    window.document.getElementsByTagName('head')[0].appendChild(script);
};
    
var parse = function (data) {
    var column_length = data.table.cols.length;
    if (!column_length || !data.table.rows.length) {
        return false;
    }
    var columns = [],
        result = [],
        row_length,
        value;
    for (var column_idx in data.table.cols) {
        columns.push(data.table.cols[column_idx].label);
    }
    for (var rows_idx in data.table.rows) {
        row_length = data.table.rows[rows_idx]['c'].length;
        if (column_length != row_length) {
            return false;
        }
        for (var row_idx in data.table.rows[rows_idx]['c']) {
            if (!result[rows_idx]) {
                result[rows_idx] = {};
            }

            value = !!data.table.rows[rows_idx]['c'][row_idx].v ? data.table.rows[rows_idx]['c'][row_idx]
                .v : null;
            if (data.table.rows[rows_idx]['c'][row_idx].f !== undefined && data.table.rows[rows_idx]['c'][
                    row_idx
                ].v !== undefined) {
                value = data.table.rows[rows_idx]['c'][row_idx].f;
            }
            result[rows_idx][columns[row_idx]] = value;
        }
    }
    return result;
};
    
var query = function (sql, sheetName, callback) {
    //var myKey = '1R-8M7lQjmAWr7Lliku57e9FU-Kjcofu2mNiLU3pkmFs';
    var myKey = '1zrQ9ngFnY4LpkAkixyzIsX0-broVIIETbyUCEqiVZ0A';
    var url = 'https://docs.google.com/spreadsheets/d/'+myKey+'/gviz/tq?',
        params = {
            tq: encodeURIComponent(sql),
            sheet: encodeURIComponent(sheetName),
            tqx: 'responseHandler:' + callback
        },
        qs = [];
    for (var key in params) {
        qs.push(key + '=' + params[key]);
    }
    url += qs.join('&');
    return jsonp(url); // Call JSONP helper function
}
    
function CreateCanvas( i, name, course, record) {
    var canvasName = "#myCanvas";
    var is = String(i);
    var _cvs = document.createElement('canvas');//document.querySelector(canvasName.concat(is));
    _cvs.width = 720;
    _cvs.height = 720;

    var _ctx = _cvs.getContext("2d");
    var _img = new Image();
    _img.src = "https://huiyueun.github.io/dy_certificate_bg.jpg";
    _img.crossOrigin="*";
        _img.onload = function(e) {
        _ctx.drawImage(_img, 0, 0);
        _ctx.fillStyle = "white";
        _ctx.font = "40pt HY견고딕"
        _ctx.fillText(name, 370,390);
        _ctx.fillText(course+"K", 370,485);
        _ctx.fillText(record, 370,570);

        var divContainer = document.getElementById("showData");

        var btn = document.createElement('Button');
        btn.addEventListener('click', function (e) {
            var dataURL = _cvs.toDataURL('image/png');
            btn.href = dataURL;
        });
        //divContainer.appendChild(btn);

        var myImage = document.createElement('img');
        myImage.crossOrigin="*";
        myImage.width=720;
        myImage.height=720;
        myImage.src = _cvs.toDataURL('image/jpg');
      //  myImage.crossOrigin = "Anonymous";
        divContainer.appendChild(myImage);
    }
}
    
var my_callback = function (data) {
    data = parse(data); // Call data parser helper function
    

    //AND THEN WHATEVER YOU WANT 
    for(var i = 0 ; i < datas.length; i++){
        if(JSON.stringify(datas[i]) == JSON.stringify(data)) {
            return false;
        }
    }
    
    datas.push(data);
    // EXTRACT VALUE FOR HTML HEADER. 
    var col = [];
    for (var i = 0; i < data.length; i++) {
        for (var key in data[i]) {
            //console.log(col.indexOf(key))
            if (col.indexOf(key) === -1) {
                col.push(key);
            }
        }
    }
    for (var i = 0; i < data.length; i++) {
        CreateCanvas(i, data[i][col[0]],data[i][col[1]],data[i][col[2]]);
    }
    
    var finish1 = document.getElementById("dr_btn1");
    finish1.src = "button_after.svg";
    var finish2 = document.getElementById("dr_btn2");
    finish2.src = "button_after.svg";
    var finish3 = document.getElementById("dr_btn3");
    finish3.src = "button_after.svg";
    
    finish1.src = "";
    finish3.src = "";
}
   
var datas = [];

//자바스크립트 onclick
//document.getElementById("dr_btn").addEventListener("click", javascript_onclikc);
//function javascript_onclikc(){
//}
function loaded(){
setTimeout(() => 
{
    console.log("Loading Start!");
    query('SELECT * WHERE B > 0 ORDER BY B DESC', '시트1', 'my_callback'); 
}, 2000);

}
    
</script>

<style>
    body {
        background-color: #0D0D0D;
    }
    table{
        margin:100px 100px;
    
        text-align:center;
        margin-left: auto;
        margin-right: auto;
        margin-bottom: auto;
    }
    div{
        text-align:center;
    }
</style>
</head>
<body id ="body" onload ="loaded();">

    <table id="top_table" width=30%>
        <tr>
            <td>
                <img src="dynamic_logo.svg" id = "dr_logo" alt="">
            </td>
        </tr>
        <tr>
            <td>
                <br>
                <br>
                <br>
                <img src="button.svg" id = "dr_btn1" alt="" type="button">
                <img src="button.svg" id = "dr_btn2" alt="" type="button">
                <img src="button.svg" id = "dr_btn3" alt="" type="button">
            </td>
        </tr>
    </table>
    <div id="showData" ></div>
</body>
</html>